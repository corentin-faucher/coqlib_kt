/** Helpers.kt
 * Fonctions diverses utiles...
 * Corentin Faucher
 * 28 novembre 2022
 * */
package com.coq.coqlib

import android.util.Log
import java.lang.ref.WeakReference
import kotlin.math.min

/** -- Notes sur kotlin: ----------------
 *
 * Attention aux Timer ! Il ne run pas dans la thread opengl. Si on cr√©e une surface (par exemple)
 * if faut se ramener √† la thread opengl...
 Timer(true).schedule(300L) {
    root.queueToGLView {
        PopMessage.over(parentNode, "Bonjour!")
    }
 }

// Equivalent de DispatchQueue.main.async...
// -> Handler(Looper.getMainLooper()).post

// Tour de passe-passe pour avoir un constructeur optional ou pr√©parer les donn√©es avant le super().
// Mettre le constructor private et cr√©er un "operator fun invoke" dans le companion object.
// Ex.:
// private constructor() {
// }
// companion object {
//    operator fun invoke() : PopSurface {
//          doStuff()
//          return MyClass()
//    }
*/

fun printerror(message: String, depth: Int = 3) {
    val stes = Exception().stackTrace
    if (stes.size < 3) {
        Log.e("üêîcoq", "‚ùå Error: $message")
        return
    }
    var str = "‚ùå Error: $message  ‚Üí ${stes[2]}"
    val depth2 = min(stes.size, depth+1)
    for (index in 3..depth2) {
        val ste = stes[index]
        str += "\n   ‚Üí $ste"
    }
    Log.e("üêîcoq", str)
}

fun printwarning(message: String, depth: Int = 1) {
    val stes = Exception().stackTrace
    if (stes.size < 3) {
        Log.w("üêîcoq", "‚ö†Ô∏è Warn.: $message")
        return
    }
    var str = "‚ö†Ô∏è Warn.: $message  ‚Üí ${stes[2]}"
    val depth2 = min(stes.size, depth+1)
    for (index in 3..depth2) {
        val ste = stes[index]
        str += "\n   ‚Üí $ste"
    }
    Log.w("üêîcoq", str)
}
fun printdebug(message: String, depth: Int = 1) {
    if (!BuildConfig.DEBUG) {
        return
    }
    val stes = Exception().stackTrace
    if (stes.size < 3) {
        Log.d("üêîcoq", "üêû Debug: $message")
        return
    }
    var str = "üêû Debug: $message  ‚Üí ${stes[2]}"
    val depth2 = min(stes.size, depth+1)
    for (index in 3..depth2) {
        val ste = stes[index]
        str += "\n   ‚Üí $ste"
    }
    Log.d("üêîcoq", str)
}

fun printhere(depth: Int = 1) {
    val stes = Exception().stackTrace
    if (stes.size < 3) {
        Log.i("üêîcoq", "üêî Now at ?? (no stack ?)")
        return
    }
    var str = "üêî Now in ${stes[2]}"
    val depth2 = min(stes.size, depth+1)
    for (index in 3..depth2) {
        val ste = stes[index]
        str += "\n   ‚Üí $ste"
    }
    Log.i("üêîcoq", str)
}

fun <K, T> MutableMap<K, WeakReference<T>>.strip() {
    forEach { (k, v) ->
        if(v.get() == null) {
            this.remove(k)
        }
    }
}

fun <T> MutableList<WeakReference<T> >.strip() {
    this.removeIf { it.get() == null }
}

